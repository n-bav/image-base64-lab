<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Image ‚áÑ Base64 Lab</title>
  <style>
    :root { --ink:#0f172a; --bg:#f8fafc; --card:#ffffff; --muted:#64748b; --ring:#e5e7eb; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: var(--bg); color: var(--ink); }
    header { padding: 16px 20px; background: var(--ink); color: white; }
    header h1 { margin:0; font-size: 18px; }
    main { padding: 16px; display: grid; gap: 16px; max-width: 1100px; margin: 0 auto; }
    .card { background: var(--card); border:1px solid var(--ring); border-radius: 16px; padding: 16px; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items: center; }
    input[type="text"], textarea { width: 100%; border:1px solid var(--ring); border-radius: 10px; padding:10px 12px; font:inherit; }
    button { border:1px solid var(--ring); background:white; padding:10px 12px; border-radius: 10px; cursor:pointer; }
    button:hover { background:#f3f4f6; }
    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(160px,1fr)); gap:12px; }
    .thumb { position: relative; border:1px solid var(--ring); border-radius: 12px; overflow:hidden; background:#fff; cursor:pointer; }
    .thumb img { width:100%; height:160px; object-fit:cover; display:block; }
    .thumb .meta { position:absolute; bottom:0; left:0; right:0; background:linear-gradient(transparent, rgba(0,0,0,.6)); color:white; font-size:12px; padding:6px 8px; }
    .badge { position:absolute; top:8px; left:8px; background: rgba(15,23,42,.9); color:#fff; font-size:11px; padding:3px 6px; border-radius:999px; display:none; }
    .thumb.mode-b64 .badge { display:inline-block; }
    .hidden { display:none; }
    .flex { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .preview { max-width:100%; max-height:360px; object-fit:contain; border:1px solid var(--ring); border-radius: 10px; }
    .cols { display:grid; grid-template-columns: 1fr; gap:16px; }
    @media (min-width: 900px) { .cols { grid-template-columns: 1.2fr 1fr; } }
    small.muted { color: var(--muted); }
    .pill { background:#f1f5f9; padding:4px 8px; border-radius: 999px; font-size:12px; }
    .toast { position:fixed; right:12px; top:12px; background:rgba(0,0,0,.82); color:#fff; padding:10px 14px; border-radius:8px; z-index:9999; font:12px/1.2 system-ui,sans-serif; }
  </style>
</head>
<body>
  <header>
    <h1>üñºÔ∏è Image ‚áÑ Base64 Lab</h1>
  </header>
  <main>
    <section class="card">
      <div class="row">
        <input id="q" type="text" placeholder="Search Wikimedia Commons (e.g., 'sunrise', 'cat', 'New York skyline')" />
        <button id="searchBtn">Search</button>
        <span class="pill">Right-click a result ‚Üí convert; left-click ‚Üí show original</span>
      </div>
      <div id="results" class="grid" style="margin-top:12px;"></div>
      <div id="noResults" class="hidden" style="margin-top:8px;">
        <small class="muted">No results. Try another term.</small>
      </div>
    </section>

    <section class="card cols">
      <div>
        <div class="flex">
          <strong>Selected Image</strong>
          <small id="imgInfo" class="muted"></small>
        </div>
        <img id="preview" class="preview" alt="Preview" />
      </div>
      <div>
        <div class="flex" style="justify-content:space-between;">
          <strong>Base64</strong>
          <div class="row">
            <button id="copyB64">Copy</button>
            <button id="downloadB64">Download .txt</button>
            <button id="downloadDecoded">Download Decoded Image</button>
          </div>
        </div>
        <textarea id="b64" rows="12" placeholder="data:image/png;base64,...."></textarea>
      </div>
    </section>
  </main>

<script>
const q = document.getElementById('q');
const searchBtn = document.getElementById('searchBtn');
const results = document.getElementById('results');
const noResults = document.getElementById('noResults');
const preview = document.getElementById('preview');
const b64ta = document.getElementById('b64');
const imgInfo = document.getElementById('imgInfo');
const copyBtn = document.getElementById('copyB64');
const downloadB64Btn = document.getElementById('downloadB64');
const downloadDecodedBtn = document.getElementById('downloadDecoded');

function toast(msg){
  const n = document.createElement('div');
  n.className = 'toast';
  n.textContent = msg;
  document.body.appendChild(n);
  setTimeout(()=> n.remove(), 2000);
}

async function searchCommons(term) {
  results.innerHTML = '';
  noResults.classList.add('hidden');
  if (!term) return;
  const endpoint = 'https://commons.wikimedia.org/w/api.php';
  const params = new URLSearchParams({
    action: 'query',
    generator: 'search',
    gsrsearch: term,
    gsrnamespace: '6',
    gsrlimit: '24',
    prop: 'imageinfo',
    iiprop: 'url|mime',
    iiurlwidth: '600',
    format: 'json',
    origin: '*'
  });
  const url = `${endpoint}?${params}`;
  try {
    const res = await fetch(url);
    const data = await res.json();
    const pages = data.query && data.query.pages ? Object.values(data.query.pages) : [];
    if (!pages.length) { noResults.classList.remove('hidden'); return; }
    pages.sort((a,b)=> (a.index||0) - (b.index||0));
    for (const p of pages) {
      const info = p.imageinfo && p.imageinfo[0];
      if (!info) continue;
      const thumb = info.thumburl || info.url;
      const full = info.url;
      const mime = info.mime || '';
      const el = document.createElement('div');
      el.className = 'thumb';
      el.dataset.full = full;
      el.dataset.mime = mime;
      el.dataset.mode = 'orig';
      el.innerHTML = `<span class="badge">BASE64</span><img src="${thumb}" alt="thumbnail"/><div class="meta">${mime.replace('image/','')}</div>`;

      // Right-click ‚Üí convert to Base64
      el.addEventListener('contextmenu', async (e) => {
        e.preventDefault();
        try {
          const {dataUrl, size} = await fetchAsDataUrl(full);
          el.dataset.b64 = dataUrl;
          el.dataset.mode = 'b64';
          el.classList.add('mode-b64');
          preview.src = dataUrl;
          b64ta.value = dataUrl;
          imgInfo.textContent = `${mime || 'image/*'} ‚Ä¢ ${Math.round(size/1024)} KB (Base64)`;
          try { await navigator.clipboard.writeText(dataUrl); toast('Base64 copied to clipboard'); } catch { toast('Base64 ready'); }
        } catch (err) {
          console.error(err);
          toast('Failed to convert (CORS or network)');
        }
      });

      // Left-click ‚Üí show original image
      el.addEventListener('click', (e) => {
        const mode = el.dataset.mode || 'orig';
        const fullUrl = el.dataset.full;
        if (mode === 'b64') {
          preview.src = fullUrl; // show original
          imgInfo.textContent = `${mime || 'image/*'} ‚Ä¢ original`;
          el.dataset.mode = 'orig';
          el.classList.remove('mode-b64');
          toast('Showing original image');
        } else {
          if (el.dataset.b64) {
            preview.src = el.dataset.b64;
            b64ta.value = el.dataset.b64;
            imgInfo.textContent = `${mime || 'image/*'} ‚Ä¢ Base64`;
            el.dataset.mode = 'b64';
            el.classList.add('mode-b64');
          } else {
            preview.src = fullUrl;
            imgInfo.textContent = `${mime || 'image/*'} ‚Ä¢ original`;
          }
        }
      });

      results.appendChild(el);
    }
  } catch (e) {
    console.error(e);
    noResults.classList.remove('hidden');
  }
}

async function fetchAsDataUrl(url){
  const res = await fetch(url, { mode: 'cors' });
  if (!res.ok) throw new Error('Fetch failed');
  const blob = await res.blob();
  const dataUrl = await blobToDataUrl(blob);
  return { dataUrl, size: blob.size };
}

function blobToDataUrl(blob) {
  return new Promise((resolve, reject) => {
    const fr = new FileReader();
    fr.onload = () => resolve(fr.result);
    fr.onerror = reject;
    fr.readAsDataURL(blob);
  });
}

function dataUrlToBlob(dataUrl) {
  const m = dataUrl.match(/^data:([^;]+);base64,(.*)$/s);
  if (!m) return null;
  const mime = m[1];
  const b64 = m[2];
  try {
    const bin = atob(b64);
    const bytes = new Uint8Array(bin.length);
    for (let i=0;i<bin.length;i++) bytes[i] = bin.charCodeAt(i);
    return new Blob([bytes], { type: mime });
  } catch { return null; }
}

copyBtn.addEventListener('click', async ()=>{
  try { await navigator.clipboard.writeText(b64ta.value); toast('Copied'); } catch { b64ta.select(); document.execCommand('copy'); toast('Copied'); }
});

downloadB64Btn.addEventListener('click', ()=>{
  const blob = new Blob([b64ta.value], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  triggerDownload(url, 'image.base64.txt');
});

downloadDecodedBtn.addEventListener('click', ()=>{
  const blob = dataUrlToBlob(b64ta.value);
  if (!blob) { alert('Paste a valid data URL first.'); return; }
  const ext = (blob.type || 'image/png').split('/')[1] || 'png';
  const url = URL.createObjectURL(blob);
  triggerDownload(url, `decoded-image.${ext}`);
});

function triggerDownload(url, name){
  const a = document.createElement('a');
  a.href = url; a.download = name; document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 5000);
}

searchBtn.addEventListener('click', () => searchCommons(q.value.trim()));
q.addEventListener('keydown', (e)=>{ if(e.key==='Enter') searchCommons(q.value.trim()); });
</script>
</body>
</html>
